<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.cursorbasepagination.dao.PostMapper">

    <!-- Kết quả ánh xạ -->
    <resultMap id="PostResultMap" type="Post">
        <id column="id" property="id" />
        <result column="title" property="title" />
        <result column="content" property="content" />
        <result column="created_at" property="createdAt" />
        <result column="user_id" property="userId" />
    </resultMap>

    <!-- Lấy trang đầu tiên -->
    <select id="findFirstPage" resultMap="PostResultMap">
        SELECT id, title, content, created_at, user_id
        FROM posts
        ORDER BY created_at DESC, id DESC
            LIMIT #{limit}
    </select>

    <!-- Lấy trang tiếp theo -->
    <select id="findNextPage" resultMap="PostResultMap">
        SELECT id, title, content, created_at, user_id
        FROM posts
        WHERE (created_at &lt; #{lastCreatedAt}) OR (created_at = #{lastCreatedAt} AND id &lt; #{lastId})
        ORDER BY created_at DESC, id DESC
            LIMIT #{limit}
    </select>

    <!-- Lấy trang trước đó (lưu ý: trả về ngược, sẽ bị đảo lại trong service) -->
    <select id="findPreviousPage" resultMap="PostResultMap">
        SELECT id, title, content, created_at, user_id
        FROM posts
        WHERE (created_at > #{firstCreatedAt}) OR (created_at = #{firstCreatedAt} AND id > #{firstId})
        ORDER BY created_at ASC, id ASC
            LIMIT #{limit}
    </select>

    <!-- Kiểm tra xem có trang trước không -->
    <select id="checkHasPrevious" resultType="Integer">
        SELECT COUNT(*)
        FROM posts
        WHERE (created_at > #{firstCreatedAt}) OR (created_at = #{firstCreatedAt} AND id > #{firstId})
            LIMIT 1
    </select>

    <!-- Thêm truy vấn với điều kiện lọc -->
    <select id="findByCategory" resultMap="PostResultMap">
        SELECT id, title, content, created_at, user_id
        FROM posts
        WHERE category = #{category}
        <if test="lastId != null and lastCreatedAt != null">
            AND ((created_at &lt; #{lastCreatedAt})
            OR (created_at = #{lastCreatedAt} AND id &lt; #{lastId}))
        </if>
        ORDER BY created_at DESC, id DESC
        LIMIT #{limit}
    </select>

    <!-- Query với nhiều điều kiện phức tạp -->
    <select id="findWithFilters" resultMap="PostResultMap">
        SELECT id, title, content, created_at, user_id
        FROM posts
        <where>
            <if test="category != null">
                category = #{category}
            </if>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="startDate != null">
                AND created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND created_at &lt;= #{endDate}
            </if>
            <if test="lastId != null and lastCreatedAt != null">
                AND ((created_at &lt; #{lastCreatedAt})
                OR (created_at = #{lastCreatedAt} AND id &lt; #{lastId}))
            </if>
        </where>
        ORDER BY created_at DESC, id DESC
        LIMIT #{limit}
    </select>
</mapper>